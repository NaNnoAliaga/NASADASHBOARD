<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NASA Biosciences AI Dashboard</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸš€ NASA Biosciences AI Dashboard</h1>
            <p>Sistema Integrado de AnÃ¡lisis de InvestigaciÃ³n Espacial</p>
            <div class="data-sources">
                <div class="data-source-badge">ğŸ“‹ NASA Taskbook</div>
                <div class="data-source-badge">ğŸ”¬ NSLSL</div>
                <div class="data-source-badge">ğŸ§¬ OSDR</div>
            </div>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('home')">ğŸ  Home</button>
            <button class="nav-tab" onclick="showTab('publications')">ğŸ“š Publicaciones PMC</button>
            <button class="nav-tab" onclick="showTab('taskbook')">ğŸ“‹ Taskbook</button>
            <button class="nav-tab" onclick="showTab('analysis')">ğŸ“Š AnÃ¡lisis</button>
        </div>

        <div class="content">
            <div id="home" class="tab-content active">
                <h2>ğŸ“Š Dashboard Principal</h2>
                <div class="metrics-grid">
                    <div class="metric-card">
                        <div class="metric-label">Publicaciones PMC</div>
                        <div class="metric-value" id="totalPublications">0</div>
                        <small>ArtÃ­culos OpenAccess</small>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Total Experimentos</div>
                        <div class="metric-value" id="totalExperiments">5</div>
                        <small>NASA Taskbook</small>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Keywords Ãšnicas</div>
                        <div class="metric-value" id="uniqueKeywords">0</div>
                        <small>ExtraÃ­das</small>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Con PMCID</div>
                        <div class="metric-value" id="withPMCID">0</div>
                        <small>Identificados</small>
                    </div>
                </div>
                <div class="file-upload-section">
                    <h3>ğŸ” Cargar Base de Datos</h3>
                    <p class="upload-description">
                        Carga tu archivo CSV con publicaciones PMC para anÃ¡lisis completo
                    </p>
                    <div class="file-upload-container">
                        <div class="file-drop-zone" id="fileDropZone">
                            <div class="drop-zone-content">
                                <div class="upload-icon">ğŸ“</div>
                                <h4>Arrastra tu archivo CSV aquÃ­</h4>
                                <p>o haz clic para seleccionar</p>
                                <div class="file-requirements">
                                    <span class="requirement">âœ“ Formato: CSV</span>
                                    <span class="requirement">âœ“ TamaÃ±o mÃ¡ximo: 50MB</span>
                                    <span class="requirement">âœ“ Estructura: SB_publication_PMC.csv</span>
                                </div>
                            </div>
                            <input type="file" id="csvFileInput" accept=".csv" onchange="loadPublicationsCSV(event)" class="hidden-file-input">
                        </div>
                        <div class="upload-progress" id="uploadProgress" style="display: none;">
                            <div class="progress-header">
                                <span class="progress-text">Procesando archivo...</span>
                                <span class="progress-percentage" id="progressPercentage">0%</span>
                            </div>
                            <div class="progress-bar-container">
                                <div class="progress-bar-fill" id="progressBarFill"></div>
                            </div>
                            <div class="progress-details" id="progressDetails">
                                Preparando anÃ¡lisis...
                            </div>
                        </div>
                        <div class="upload-result" id="uploadResult" style="display: none;">
                            <div class="result-icon" id="resultIcon">âœ…</div>
                            <div class="result-content">
                                <h4 id="resultTitle">Archivo cargado exitosamente</h4>
                                <p id="resultDescription">Tu archivo ha sido procesado correctamente</p>
                                <div class="result-stats" id="resultStats"></div>
                            </div>
                        </div>
                    </div>
                    <div class="upload-actions">
                        <button class="btn btn-secondary" onclick="clearUpload()" id="clearUploadBtn" style="display: none;">
                            ğŸ—‘ï¸ Limpiar y cargar otro
                        </button>
                    </div>
                </div>
            </div>

                        <div id="publications" class="tab-content">
                <h2>ğŸ“š Publicaciones PMC</h2>
                
                <div class="alert alert-success">
                    <strong>ğŸ“Š Estado:</strong> <span id="publicationsStatus">Esperando carga de archivo CSV...</span>
                </div>

                <div class="alert alert-info" id="scrapingStatus" style="display: none;">
                    <strong>ğŸŒ Web Scraping:</strong> <span id="scrapingStatusText"></span>
                    <div class="scraping-progress">
                        <div class="progress-bar" id="scrapingProgress"></div>
                    </div>
                </div>

                <div class="chart-container">
                    <h3>ğŸ“Š AnÃ¡lisis EstadÃ­stico</h3>
                    <div class="stats-grid">
                        <div class="stat-box">
                            <div class="stat-value" id="totalPubsStats">0</div>
                            <div class="stat-label">Total Publicaciones</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value" id="uniqueKeywordsStats">0</div>
                            <div class="stat-label">Keywords Ãšnicas</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value" id="avgTitleLength">0</div>
                            <div class="stat-label">Promedio Palabras/TÃ­tulo</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value" id="withPMCIDStats">0</div>
                            <div class="stat-label">Con PMCID</div>
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="generateStatistics()">ğŸ“ˆ Generar EstadÃ­sticas</button>
                    <button class="btn btn-secondary" onclick="exportStatistics()">ğŸ’¾ Exportar AnÃ¡lisis</button>
                </div>

                <div class="filter-panel">
                    <h3>ğŸ” BÃºsqueda Inteligente NASA</h3>
                    <p style="color: #666; font-size: 0.9rem; margin-bottom: 15px;">
                        ğŸŒ Busca en tiempo real en: OSDR, NSLSL, NASA Taskbook y datos locales
                    </p>
                    <input type="text" id="publicationsSearch" class="search-box" 
                           placeholder="Buscar por tÃ­tulo, palabras clave, PMCID... (bÃºsqueda automÃ¡tica)">
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn btn-primary" onclick="searchPublications()">ğŸ” Buscar Ahora</button>
                        <button class="btn btn-secondary" onclick="clearSearch()">ğŸ—‘ï¸ Limpiar</button>
                    </div>
                </div>

                <div id="publicationsList"></div>
            </div>

            <div id="taskbook" class="tab-content">
                <h2>ğŸ“‹ NASA Taskbook</h2>
                
                <div class="alert alert-info">
                    <strong>ğŸŒ NASA Task Book:</strong> Base de datos oficial de proyectos de investigaciÃ³n espacial (FY2004-presente)
                </div>

                <div class="filter-panel">
                    <h3>ğŸ” BÃºsqueda en NASA Taskbook</h3>
                    <div class="search-grid">
                        <div class="search-row">
                            <label>ğŸ¯ Palabras Clave:</label>
                            <input type="text" id="taskbookKeywords" class="search-box" 
                                   placeholder="ej: microgravity, bone loss, space biology...">
                        </div>
                        <div class="search-row">
                            <label>ğŸ‘¨â€ğŸ”¬ Investigador:</label>
                            <input type="text" id="taskbookInvestigator" class="search-box" 
                                   placeholder="Apellido del investigador principal...">
                        </div>
                        <div class="search-row">
                            <label>ğŸ¢ Programa:</label>
                            <select id="taskbookProgram" class="search-select">
                                <option value="">Todos los programas</option>
                                <option value="Human Research">Human Research</option>
                                <option value="Space Biology">Space Biology</option>
                                <option value="Physical Sciences">Physical Sciences</option>
                            </select>
                        </div>
                        <div class="search-row">
                            <label>ğŸ“… AÃ±o Fiscal:</label>
                            <select id="taskbookYear" class="search-select">
                                <option value="">Todos los aÃ±os</option>
                                <option value="2024">2024</option>
                                <option value="2023">2023</option>
                                <option value="2022">2022</option>
                                <option value="2021">2021</option>
                                <option value="2020">2020</option>
                            </select>
                        </div>
                    </div>
                    <div class="search-actions">
                        <button class="btn btn-primary" onclick="searchTaskbookAdvanced()">
                            ğŸ” Buscar Proyectos
                        </button>
                        <button class="btn btn-secondary" onclick="clearTaskbookSearch()">
                            ğŸ—‘ï¸ Limpiar
                        </button>
                    </div>
                </div>

                <div class="alert alert-warning" id="taskbookStatus" style="display: none;">
                    <strong>ğŸ”„ Buscando:</strong> <span id="taskbookStatusText"></span>
                    <div class="scraping-progress">
                        <div class="progress-bar" id="taskbookProgress"></div>
                    </div>
                </div>

                <div id="taskbookResults"></div>
            </div>

            <div id="analysis" class="tab-content">
                <h2>ğŸ“Š AnÃ¡lisis de Keywords</h2>
                <div class="chart-container">
                    <h3>ğŸ·ï¸ Keywords ExtraÃ­das</h3>
                    <div id="extractedKeywords"></div>
                    <button class="btn btn-primary" onclick="extractKeywords()">ğŸ” Extraer Keywords</button>
                    <button class="btn btn-secondary" onclick="downloadKeywords()">ğŸ’¾ Descargar Keywords</button>
                </div>
                <div class="chart-container">
                    <h3>â˜ï¸ Nube de Palabras</h3>
                    <div id="wordCloudContainer" class="wordcloud-container"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Agrega este cÃ³digo antes de cerrar </body> en tu HTML -->

<!-- ChatGPT Widget Styles -->
<style>
.chatgpt-widget {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 9999;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
}

.chat-button {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: linear-gradient(135deg, #0B3D91 0%, #1E88E5 100%);
    border: none;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(11, 61, 145, 0.4);
    display: flex;
    align-items: center;
    justify-content: center;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.chat-button:hover {
    transform: scale(1.1);
    box-shadow: 0 6px 20px rgba(11, 61, 145, 0.6);
}

.chat-button svg {
    width: 28px;
    height: 28px;
    fill: white;
}

.chat-window {
    position: fixed;
    bottom: 90px;
    right: 20px;
    width: 380px;
    height: 550px;
    background: white;
    border-radius: 16px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
    display: none;
    flex-direction: column;
    overflow: hidden;
}

.chat-window.open {
    display: flex;
    animation: slideUp 0.3s ease;
}

@keyframes slideUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.chat-header {
    background: linear-gradient(135deg, #0B3D91 0%, #1E88E5 100%);
    color: white;
    padding: 16px;
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.chat-header-content {
    display: flex;
    align-items: center;
    gap: 10px;
}

.chat-header h3 {
    margin: 0;
    font-size: 16px;
    font-weight: 600;
}

.chat-header p {
    margin: 0;
    font-size: 12px;
    opacity: 0.9;
}

.close-chat {
    background: none;
    border: none;
    color: white;
    cursor: pointer;
    font-size: 24px;
    padding: 0;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
    background: #f8f9fa;
}

.message {
    margin-bottom: 16px;
    display: flex;
    gap: 10px;
}

.message.user {
    flex-direction: row-reverse;
}

.message-avatar {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    flex-shrink: 0;
}

.message.bot .message-avatar {
    background: linear-gradient(135deg, #0B3D91 0%, #1E88E5 100%);
}

.message.user .message-avatar {
    background: #e3f2fd;
}

.message-content {
    max-width: 70%;
    padding: 12px 16px;
    border-radius: 12px;
    line-height: 1.5;
    font-size: 14px;
}

.message.bot .message-content {
    background: white;
    color: #333;
    border-bottom-left-radius: 4px;
}

.message.user .message-content {
    background: #0B3D91;
    color: white;
    border-bottom-right-radius: 4px;
}

.typing-indicator {
    display: none;
    padding: 12px 16px;
    background: white;
    border-radius: 12px;
    width: fit-content;
}

.typing-indicator span {
    display: inline-block;
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #0B3D91;
    margin: 0 2px;
    animation: typing 1.4s infinite;
}

.typing-indicator span:nth-child(2) {
    animation-delay: 0.2s;
}

.typing-indicator span:nth-child(3) {
    animation-delay: 0.4s;
}

@keyframes typing {
    0%, 60%, 100% {
        transform: translateY(0);
    }
    30% {
        transform: translateY(-10px);
    }
}

.chat-input-area {
    padding: 16px;
    background: white;
    border-top: 1px solid #e0e0e0;
}

.chat-input-container {
    display: flex;
    gap: 10px;
    align-items: center;
}

.chat-input {
    flex: 1;
    padding: 12px 16px;
    border: 1px solid #e0e0e0;
    border-radius: 24px;
    font-size: 14px;
    outline: none;
    transition: border-color 0.3s;
}

.chat-input:focus {
    border-color: #0B3D91;
}

.send-button {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: linear-gradient(135deg, #0B3D91 0%, #1E88E5 100%);
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: transform 0.2s;
}

.send-button:hover {
    transform: scale(1.1);
}

.send-button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.send-button svg {
    width: 20px;
    height: 20px;
    fill: white;
}

@media (max-width: 480px) {
    .chat-window {
        width: calc(100vw - 40px);
        height: calc(100vh - 120px);
        bottom: 90px;
        right: 20px;
    }
}
</style>

<!-- ChatGPT Widget HTML -->
<div class="chatgpt-widget">
    <button class="chat-button" onclick="toggleChat()">
        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 2C6.48 2 2 6.48 2 12c0 1.54.36 3 .97 4.29L2 22l5.71-.97C9 21.64 10.46 22 12 22c5.52 0 10-4.48 10-10S17.52 2 12 2zm0 18c-1.38 0-2.68-.29-3.87-.81l-.28-.13-2.85.48.48-2.85-.13-.28C4.29 14.68 4 13.38 4 12c0-4.41 3.59-8 8-8s8 3.59 8 8-3.59 8-8 8z"/>
        </svg>
    </button>
    
    <div class="chat-window" id="chatWindow">
        <div class="chat-header">
            <div class="chat-header-content">
                <div>ğŸš€</div>
                <div>
                    <h3>NASA AI Assistant</h3>
                    <p>Powered by ChatGPT</p>
                </div>
            </div>
            <button class="close-chat" onclick="toggleChat()">Ã—</button>
        </div>
        
        <div class="chat-messages" id="chatMessages">
            <div class="message bot">
                <div class="message-avatar">ğŸ¤–</div>
                <div class="message-content">
                    Â¡Hola! Soy tu asistente de NASA Biosciences. Â¿En quÃ© puedo ayudarte hoy?
                </div>
            </div>
            <div class="typing-indicator" id="typingIndicator">
                <span></span><span></span><span></span>
            </div>
        </div>
        
        <div class="chat-input-area">
            <div class="chat-input-container">
                <input 
                    type="text" 
                    class="chat-input" 
                    id="chatInput" 
                    placeholder="Escribe tu mensaje..."
                    onkeypress="handleKeyPress(event)"
                >
                <button class="send-button" id="sendButton" onclick="sendMessage()">
                    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                    </svg>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ChatGPT Widget Script -->
<script>
// ConfiguraciÃ³n
const CHATGPT_CONFIG = {
    // IMPORTANTE: Reemplaza con tu API key de OpenAI
    // Para producciÃ³n, usa variables de entorno en Vercel
    apiKey: process.env.OPENAI_API_KEY || 'TU_API_KEY_AQUI',
    model: 'gpt-4o-mini', // MÃ¡s econÃ³mico y rÃ¡pido
    temperature: 0.7,
    maxTokens: 500,
    systemPrompt: `Eres un asistente experto en NASA Biosciences. Ayudas a investigadores con:
- InformaciÃ³n sobre experimentos espaciales y biologÃ­a espacial
- AnÃ¡lisis de publicaciones cientÃ­ficas
- BÃºsquedas en NASA Taskbook, OSDR y NSLSL
- InterpretaciÃ³n de datos de investigaciÃ³n

Responde de manera clara, profesional y Ãºtil. Si no sabes algo, sÃ© honesto.`
};

let conversationHistory = [];

function toggleChat() {
    const chatWindow = document.getElementById('chatWindow');
    chatWindow.classList.toggle('open');
    
    if (chatWindow.classList.contains('open')) {
        document.getElementById('chatInput').focus();
    }
}

function handleKeyPress(event) {
    if (event.key === 'Enter') {
        sendMessage();
    }
}

async function sendMessage() {
    const input = document.getElementById('chatInput');
    const message = input.value.trim();
    
    if (!message) return;
    
    // Agregar mensaje del usuario
    addMessage(message, 'user');
    input.value = '';
    
    // Deshabilitar input mientras procesa
    const sendButton = document.getElementById('sendButton');
    sendButton.disabled = true;
    input.disabled = true;
    
    // Mostrar indicador de escritura
    showTypingIndicator();
    
    try {
        const response = await callChatGPT(message);
        hideTypingIndicator();
        addMessage(response, 'bot');
    } catch (error) {
        hideTypingIndicator();
        addMessage('Lo siento, hubo un error al procesar tu mensaje. Por favor intenta nuevamente.', 'bot');
        console.error('Error:', error);
    } finally {
        sendButton.disabled = false;
        input.disabled = false;
        input.focus();
    }
}

function addMessage(text, sender) {
    const messagesContainer = document.getElementById('chatMessages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${sender}`;
    
    const avatar = document.createElement('div');
    avatar.className = 'message-avatar';
    avatar.textContent = sender === 'user' ? 'ğŸ‘¤' : 'ğŸ¤–';
    
    const content = document.createElement('div');
    content.className = 'message-content';
    content.textContent = text;
    
    messageDiv.appendChild(avatar);
    messageDiv.appendChild(content);
    
    // Insertar antes del indicador de escritura
    const typingIndicator = document.getElementById('typingIndicator');
    messagesContainer.insertBefore(messageDiv, typingIndicator);
    
    // Scroll al final
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

function showTypingIndicator() {
    document.getElementById('typingIndicator').style.display = 'block';
    const messagesContainer = document.getElementById('chatMessages');
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

function hideTypingIndicator() {
    document.getElementById('typingIndicator').style.display = 'none';
}

async function callChatGPT(userMessage) {
    // Agregar mensaje a historial
    conversationHistory.push({
        role: 'user',
        content: userMessage
    });
    
    // Limitar historial a Ãºltimos 10 mensajes para no exceder tokens
    if (conversationHistory.length > 10) {
        conversationHistory = conversationHistory.slice(-10);
    }
    
    const response = await fetch('https://api.openai.com/v1/chat/completions', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${CHATGPT_CONFIG.apiKey}`
        },
        body: JSON.stringify({
            model: CHATGPT_CONFIG.model,
            messages: [
                {
                    role: 'system',
                    content: CHATGPT_CONFIG.systemPrompt
                },
                ...conversationHistory
            ],
            temperature: CHATGPT_CONFIG.temperature,
            max_tokens: CHATGPT_CONFIG.maxTokens
        })
    });
    
    if (!response.ok) {
        throw new Error(`API Error: ${response.status}`);
    }
    
    const data = await response.json();
    const assistantMessage = data.choices[0].message.content;
    
    // Agregar respuesta al historial
    conversationHistory.push({
        role: 'assistant',
        content: assistantMessage
    });
    
    return assistantMessage;
}

// Inicializar widget
document.addEventListener('DOMContentLoaded', function() {
    console.log('ğŸš€ ChatGPT Widget inicializado para NASA Dashboard');
});
</script>
</body>
</html>
